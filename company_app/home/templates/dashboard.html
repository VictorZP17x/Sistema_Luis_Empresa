{% extends 'home.html' %}
{% block content %}
{% load static %}

<body class="dashboard-page">
    <div class="pc-container">
        <div class="pc-content">
            <div class="row">
                <div class="col-md-6 col-xl-4">
                    <div class="card">
                        <div class="card-body">
                            <h6 class="mb-4">Empresas</h6>
                            <div class="row d-flex align-items-center">
                                <div class="col-9">
                                    <h3 class="f-w-300 d-flex align-items-center m-b-0"><i
                                            class="feather icon-briefcase text-primary f-30 m-r-10"></i>5</h3>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 col-xl-4">
                    <div class="card">
                        <div class="card-body">
                            <h6 class="mb-4">Usuarios</h6>
                            <div class="row d-flex align-items-center">
                                <div class="col-9">
                                    <h3 class="f-w-300 d-flex align-items-center  m-b-0"><i
                                            class="feather icon-users text-info f-30 m-r-10"></i>10</h3>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-12 col-xl-4">
                    <div class="card">
                        <div class="card-body">
                            <h6 class="mb-4">Solicitudes</h6>
                            <div class="row d-flex align-items-center">
                                <div class="col-9">
                                    <h3 class="f-w-300 d-flex align-items-center  m-b-0"><i
                                            class="feather icon-file-text text-warning f-30 m-r-10"></i>24</h3>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Cards de empresas ajustables automáticamente -->
            <div class="row justify-content-center mb-3">
                <div class="col-12 col-md-6">
                    <div class="input-group">
                        <span class="input-group-text"><i class="bi bi-search"></i></span>
                        <input type="text" id="buscador-empresas" class="form-control"
                            placeholder="Buscar empresa por nombre, dirección, teléfono o RIF...">
                    </div>
                </div>
            </div>
            <div class="row mt-4 justify-content-center" id="cards-empresas">
                {% if companies %}
                {% for company in companies %}
                <div class="col-12 col-sm-6 col-md-4 col-lg-3 d-flex align-items-stretch mb-4">
                    <div class="card shadow-sm company-card w-100">
                        <div class="card-header text-center">
                            <h6 class="mb-0">{{ company.name }}</h6>
                        </div>
                        <div class="card-body text-center">
                            <!-- Card de empresa -->
                            <div class="company-card-img mb-2"
                                style="width:100%; height:180px; overflow:hidden; display:flex; align-items:center; justify-content:center;">
                                {% if company.photo %}
                                <img src="{{ company.photo.url }}" alt="{{ company.name }}"
                                    class="img-fluid w-100 h-100"
                                    style="object-fit: cover; cursor:pointer; border-radius: 8px;"
                                    data-bs-toggle="modal" data-bs-target="#empresaFotoModal{{ company.id }}">
                                {% else %}
                                <img src="{% static 'assets/img/default-company.png' %}" alt="{{ company.name }}"
                                    class="img-fluid w-100 h-100"
                                    style="object-fit: cover; cursor:pointer; border-radius: 8px;"
                                    data-bs-toggle="modal" data-bs-target="#empresaFotoModal{{ company.id }}">
                                {% endif %}
                            </div>
                            <div class="mb-2">
                                <small class="text-muted">Dirección</small><br>
                                <span>{{ company.address }}</span>
                            </div>
                            <div class="mb-2">
                                <small class="text-muted">Teléfono</small><br>
                                <span>{{ company.phone_number }}</span>
                            </div>
                            <div class="mb-2">
                                <small class="text-muted">RIF</small><br>
                                <span>{{ company.rif }}</span>
                            </div>
                            <div class="company-description d-none">{{ company.description }}</div>
                            <button class="btn btn-primary btn-sm mt-2 btn-ver-mas" data-bs-toggle="modal"
                                data-bs-target="#empresaModal{{ company.id }}">
                                Ver más
                            </button>
                        </div>
                    </div>
                </div>
                {% endfor %}
                {% else %}
                <div class="col-12">
                    <div class="alert alert-info text-center my-5">
                        No hay Empresas registradas en el sistema.
                    </div>
                </div>
                {% endif %}
            </div>

            {% for company in companies %}
            <div class="modal fade" id="empresaModal{{ company.id }}" tabindex="-1"
                aria-labelledby="empresaModalLabel{{ company.id }}" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="empresaModalLabel{{ company.id }}">{{ company.name }}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"
                                aria-label="Cerrar"></button>
                        </div>
                        <div class="modal-body">
                            <div><strong>Descripción:</strong> {{ company.description }}</div>
                            <div><strong>Dirección:</strong> {{ company.address }}</div>
                            <div><strong>Teléfono:</strong> {{ company.phone_number }}</div>
                            <div><strong>RIF:</strong> {{ company.rif }}</div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}

            {% for company in companies %}
            <div class="modal fade" id="empresaFotoModal{{ company.id }}" tabindex="-1"
                aria-labelledby="empresaFotoModalLabel{{ company.id }}" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered modal-xl">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="empresaFotoModalLabel{{ company.id }}">Foto de {{ company.name
                                }}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"
                                aria-label="Cerrar"></button>
                        </div>
                        <div class="modal-body d-flex justify-content-center align-items-center"
                            style="min-height:400px;">
                            {% if company.photo %}
                            <img src="{{ company.photo.url }}" alt="Foto de {{ company.name }}"
                                class="img-fluid rounded" style="max-width:100%; max-height:600px; object-fit:contain;">
                            {% else %}
                            <img src="{% static 'assets/img/default-company.png' %}" alt="Foto de {{ company.name }}"
                                class="img-fluid rounded" style="max-width:100%; max-height:600px; object-fit:contain;">
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
</body>
<script>
    // filepath: c:\xampp\htdocs\Sistema_Luis_Empresa\company_app\home\templates\dashboard.html
    document.addEventListener("DOMContentLoaded", function () {
        const buscador = document.getElementById("buscador-empresas");
        const cardsEmpresas = document.getElementById("cards-empresas");
        const alertaNoResultados = document.createElement("div");
        alertaNoResultados.className = "col-12";
        alertaNoResultados.innerHTML = `
        <div class="alert alert-warning text-center my-5">
            No se encontraron empresas que coincidan con la búsqueda.
        </div>
    `;

        buscador.addEventListener("input", function () {
            const filtro = buscador.value.trim().toLowerCase();
            let hayCoincidencias = false;

            document.querySelectorAll("#cards-empresas .company-card").forEach(function (card) {
                const nombre = card.querySelector("h6").textContent.toLowerCase();
                const direccion = card.querySelectorAll("span")[0].textContent.toLowerCase();
                const telefono = card.querySelectorAll("span")[1].textContent.toLowerCase();
                const rif = card.querySelectorAll("span")[2].textContent.toLowerCase();
                const descripcion = card.querySelector(".company-description").textContent.toLowerCase();

                if (
                    nombre.includes(filtro) ||
                    direccion.includes(filtro) ||
                    telefono.includes(filtro) ||
                    rif.includes(filtro) ||
                    descripcion.includes(filtro)
                ) {
                    card.parentElement.style.display = "";
                    hayCoincidencias = true;
                } else {
                    card.parentElement.style.display = "none";
                }
            });

            // Mostrar mensaje si no hay coincidencias
            if (!hayCoincidencias) {
                if (!cardsEmpresas.contains(alertaNoResultados)) {
                    cardsEmpresas.appendChild(alertaNoResultados);
                }
            } else {
                if (cardsEmpresas.contains(alertaNoResultados)) {
                    cardsEmpresas.removeChild(alertaNoResultados);
                }
            }
        });
    });
</script>

{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
{% endblock %}

{% block extra_js %}
{% endblock %}